<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Offline GeoTIFF Viewer</title>
    <link rel="stylesheet" href="leaflet.css"> <!-- Local Leaflet CSS -->
    <style>
        #map { height: 100vh; }
        .file-input { position: absolute; top: 10px; left: 10px; z-index: 1000; }
    </style>
</head>
<body>

<div id="map"></div>
<input type="file" id="file-input" class="file-input" accept=".tif, .tiff" />

<script src="leaflet.js"></script> <!-- Local Leaflet JS -->
<script src="geotiff.js"></script> <!-- Local geotiff.js -->
<script src="proj4.js"></script> <!-- Local Proj4.js, if needed for projections -->

<script>
    // Initialize Leaflet map
    const map = L.map('map').setView([0, 0], 2); // Start zoomed out

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: '© OpenStreetMap contributors'
    }).addTo(map);

    // Access user’s current location
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition((position) => {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            map.setView([lat, lng], 10); // Zoom into user location
            L.marker([lat, lng]).addTo(map).bindPopup("You are here").openPopup();
        });
    }

    // Handle file input and load GeoTIFF
    document.getElementById('file-input').addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (file && file.size <= 50 * 1024 * 1024) { // Check file size
            const arrayBuffer = await file.arrayBuffer();
            const tiff = await GeoTIFF.fromArrayBuffer(arrayBuffer);
            const image = await tiff.getImage();
            const rasterData = await image.readRasters({ window: [0, 0, image.getWidth(), image.getHeight()] });
            
            // Get bounding box and project it
            const bbox = image.getBoundingBox();
            const corners = [
                [bbox[1], bbox[0]], // SW
                [bbox[3], bbox[2]]  // NE
            ];

            // Create a Leaflet image overlay
            const canvas = document.createElement('canvas');
            canvas.width = image.getWidth();
            canvas.height = image.getHeight();
            const ctx = canvas.getContext('2d');

            // Render GeoTIFF data on canvas
            const imageData = ctx.createImageData(canvas.width, canvas.height);
            for (let i = 0; i < rasterData[0].length; i++) {
                const value = rasterData[0][i];
                imageData.data[i * 4] = value;      // Red
                imageData.data[i * 4 + 1] = value;  // Green
                imageData.data[i * 4 + 2] = value;  // Blue
                imageData.data[i * 4 + 3] = 255;    // Alpha
            }
            ctx.putImageData(imageData, 0, 0);

            // Add the canvas as a Leaflet overlay
            const overlay = L.imageOverlay.canvas(corners, { opacity: 0.5 });
            overlay.getElement().getContext('2d').drawImage(canvas, 0, 0);
            overlay.addTo(map);
        } else {
            alert("Please select a GeoTIFF file under 50MB.");
        }
    });
</script>
</body>
</html>
